<app-auth-content>
    <div class="app-title">
        <div>
            <h1><i class="bi bi-speedometer"></i> Devices</h1>
            <p>รายการข้อมูลครุภัณฑ์{{ Title }}</p>
        </div>
        <ul class="app-breadcrumb breadcrumb">
            <li class="breadcrumb-item"><a [routerLink]="['/', AppUrl.Authen, AuthUrl.Dashboard]"><i
                        class="bi bi-house-door fs-6"></i></a></li>
            <li class="breadcrumb-item"><a [routerLink]="[]">Devices</a></li>
        </ul>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="tile">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <!-- Clear Filter Button -->
                    <button class="btn btn-outline-secondary" type="button" (click)="onResetSearch()"
                        title="ล้างตัวกรองทั้งหมด">
                        <i class="bi bi-x-circle"></i> ล้างตัวกรอง
                    </button>

                    <!-- Status Dropdown -->
                    <div class="dropdown" dropdown>
                        <button dropdownToggle type="button" class="btn btn-outline-primary dropdown-toggle"
                            aria-controls="statusDropdown">
                            <i class="bi bi-funnel"></i> สถานะ
                            <span class="badge bg-primary ms-1">{{ selectedStatusIds.length }}/{{ statusItems.length
                                }}</span>
                        </button>
                        <ul *dropdownMenu class="dropdown-menu p-2" style="min-width: 200px;">
                            <li *ngFor="let status of statusItems" class="dropdown-item-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" [id]="'status-' + status.status_id"
                                        [checked]="selectedStatusIds.includes(status.status_id!)"
                                        (change)="onStatusChange(status.status_id!, $any($event.target).checked)">
                                    <label class="form-check-label w-100" [for]="'status-' + status.status_id"
                                        style="cursor: pointer;">
                                        <span class="badge" [ngClass]="{
                                            'bg-success': status.status_id === '1',
                                            'bg-warning text-dark': status.status_id === '2',
                                            'bg-danger': status.status_id === '3',
                                            'bg-secondary': status.status_id === '4'
                                        }">
                                            {{ status.status_name }}
                                        </span>
                                    </label>
                                </div>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li class="d-flex gap-1 px-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill" type="button"
                                    (click)="selectAllStatuses()">เลือกทั้งหมด</button>
                                <button class="btn btn-sm btn-outline-secondary flex-fill" type="button"
                                    (click)="clearAllStatuses()">ยกเลิกทั้งหมด</button>
                            </li>
                        </ul>
                    </div>

                    <!-- Connection Dropdown -->
                    <div class="dropdown" dropdown>
                        <button dropdownToggle type="button" class="btn btn-outline-info dropdown-toggle"
                            aria-controls="connectionDropdown">
                            <i class="bi bi-broadcast"></i> การเชื่อมต่อ
                            <span class="badge bg-info ms-1">{{ selectedConnectionTypes.length }}/{{
                                connectionOptions.length }}</span>
                        </button>
                        <ul *dropdownMenu class="dropdown-menu p-2" style="min-width: 200px;">
                            <li *ngFor="let conn of connectionOptions" class="dropdown-item-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" [id]="'conn-' + conn.key"
                                        [checked]="selectedConnectionTypes.includes(conn.key)"
                                        (change)="onConnectionChange(conn.key, $any($event.target).checked)">
                                    <label class="form-check-label w-100" [for]="'conn-' + conn.key"
                                        style="cursor: pointer;">
                                        <i class="bi" [ngClass]="conn.icon"></i>
                                        <span class="badge ms-1" [ngClass]="{
                                            'bg-success': conn.key === 'online',
                                            'bg-danger': conn.key === 'offline',
                                            'bg-warning text-dark': conn.key === 'ma'
                                        }">
                                            {{ conn.label }}
                                        </span>
                                    </label>
                                </div>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li class="d-flex gap-1 px-2">
                                <button class="btn btn-sm btn-outline-info flex-fill" type="button"
                                    (click)="selectAllConnections()">เลือกทั้งหมด</button>
                                <button class="btn btn-sm btn-outline-secondary flex-fill" type="button"
                                    (click)="clearAllConnections()">ยกเลิกทั้งหมด</button>
                            </li>
                        </ul>
                    </div>

                    <!-- Search Bar -->
                    <div class="flex-grow-1">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" [(ngModel)]="searchText" (input)="onSearchItem()"
                                placeholder="ค้นหา... (เลขครุภัณฑ์, ชื่อ, ยี่ห้อ, IP, สถานที่)" name="searchText">
                        </div>
                    </div>
                </div>
                <div *ngIf="isLoading" class="text-center mt-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="table-responsive" *ngIf="!isLoading">
                    <table class="table table-striped table-bordered table-hover">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 10%">เลขครุภัณฑ์</th>
                                <th class="text-center" style="width: 15%">รายการ</th>
                                <th class="text-center" style="width: 8%">ยี่ห้อ</th>
                                <th class="text-center" style="width: 8%">รุ่น</th>
                                <th class="text-center" style="width: 8%">ชั้น</th>
                                <th class="text-center" style="width: 12%">สถานที่</th>
                                <th class="text-center" style="width: 10%">รายละเอียด</th>
                                <th class="text-center" style="width: 10%">สถานะ</th>
                                <th class="text-center" style="width: 10%">IP</th>
                                <th class="text-center" style="width: 5%">Ping</th>
                                <th class="text-center" style="width: 4%">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of cctvItems">
                                <td>{{ item.durable_no }}</td>
                                <td>{{ item.durable_name }}</td>
                                <td>{{ item.brand }}</td>
                                <td>{{ item.model }}</td>
                                <td>{{ item.floor }}</td>
                                <td>{{ item.location }}</td>
                                <td>{{ item.monitor }}</td>
                                <td class="text-center">
                                    <span class="badge" [ngClass]="{
                                              'bg-success': item.status_id === '1',
                                              'bg-warning text-dark': item.status_id === '2',
                                              'bg-danger': item.status_id === '3',
                                              'bg-secondary': item.status_id === '4'
                                          }">
                                        {{ item.status }}
                                    </span>
                                </td>

                                <td><a href="http://{{ item.ip }}" target="_blank">{{ item.ip }}</a></td>
                                <td class="text-center">
                                    <ng-container *ngIf="item.maintenance_mode == 1; else normalPing">
                                        <span class="badge bg-warning text-dark"><i class="bi bi-tools"></i> MA</span>
                                    </ng-container>
                                    <ng-template #normalPing>
                                        <span class="badge" [ngClass]="item.ping === '0' ? 'bg-success' : 'bg-danger'">
                                            {{ item.ping === '0' ? 'Online' : 'Offline' }}
                                        </span>
                                    </ng-template>
                                </td>
                                <td align="center">
                                    <a [routerLink]="[]" data-bs-toggle="modal" data-bs-target="#editCctvModal"
                                        (click)="onEditModal(item)">
                                        <span class="badge bg-warning"><i class="bi bi-pencil-square"
                                                title="Edit"></i></span>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="11">จำนวนรายการทั้งหมด {{ cctvItems.length }} รายการ</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Modal HTML -->
    <div id="editCctvModal" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form (submit)="onSubmit()">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>แก้ไขรายการครุภัณฑ์</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Column 1: Basic Info -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3 border-bottom pb-2">ข้อมูลทั่วไป</h6>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">เลขครุภัณฑ์</label>
                                    <input type="text" class="form-control" required placeholder="ระบุเลขครุภัณฑ์"
                                        [(ngModel)]="model.durable_no" name="durable_no">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">รายการ</label>
                                    <input type="text" class="form-control" required placeholder="ระบุชื่อรายการ"
                                        [(ngModel)]="model.durable_name" name="durable_name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">ยี่ห้อ</label>
                                    <input type="text" class="form-control" required placeholder="ระบุยี่ห้อ"
                                        [(ngModel)]="model.brand" name="brand">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">รุ่น</label>
                                    <input type="text" class="form-control" required placeholder="ระบุรุ่น"
                                        [(ngModel)]="model.model" name="model">
                                </div>
                            </div>

                            <!-- Column 2: Location & Status -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3 border-bottom pb-2">สถานที่และสถานะ</h6>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">ชั้น</label>
                                    <select class="form-select" [(ngModel)]="model.floor_id" name="floor">
                                        <option value="">กรุณาเลือกชั้น</option>
                                        <option *ngFor="let item of floorItems" [value]="item.floor_id">{{
                                            item.floor_name }}
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">สถานที่</label>
                                    <input type="text" class="form-control" required placeholder="ระบุสถานที่ติดตั้ง"
                                        [(ngModel)]="model.location" name="location">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Monitor</label>
                                    <input type="text" class="form-control" required placeholder="ระบุ Monitor"
                                        [(ngModel)]="model.monitor" name="monitor">
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">สถานะ</label>
                                        <select class="form-select" [(ngModel)]="model.status_id" name="status">
                                            <option value="">เลือกสถานะ</option>
                                            <option *ngFor="let item of statusItems" [value]="item.status_id">{{
                                                item.status_name }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">IP Address</label>
                                        <input type="text" class="form-control font-monospace" required
                                            placeholder="xxx.xxx.xxx.xxx" [(ngModel)]="model.ip" name="ip">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reference Image Section -->
                        <div class="mt-4 p-3 rounded border bg-light">
                            <h6 class="text-muted mb-3 border-bottom pb-2"><i class="bi bi-image me-2"></i>รูปภาพอ้างอิง
                            </h6>
                            <div class="row align-items-center">
                                <div class="col-md-4 text-center">
                                    <div class="border rounded p-2" style="min-height: 150px; background: #f8f9fa;">
                                        <img *ngIf="model.image_path" [src]="getImageUrl(model.image_path)"
                                            class="img-fluid rounded" style="max-height: 140px; object-fit: contain;"
                                            alt="รูปอ้างอิง">
                                        <div *ngIf="!model.image_path"
                                            class="d-flex flex-column align-items-center justify-content-center h-100 text-muted"
                                            style="min-height: 140px;">
                                            <i class="bi bi-image" style="font-size: 3rem;"></i>
                                            <small>ยังไม่มีรูปภาพ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="mb-2">
                                        <label class="form-label fw-bold">อัพโหลดรูปภาพใหม่</label>
                                        <input type="file" class="form-control" accept="image/*"
                                            (change)="onImageSelected($event)" #imageInput>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary btn-sm" (click)="uploadImage()"
                                            [disabled]="!selectedImageFile || isUploading">
                                            <i class="bi bi-upload me-1"></i>
                                            {{ isUploading ? 'กำลังอัพโหลด...' : 'อัพโหลด' }}
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                            (click)="deleteImage()" [disabled]="!model.image_path || isUploading">
                                            <i class="bi bi-trash me-1"></i>ลบรูป
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mt-2">รองรับ: JPG, PNG, GIF, WebP (ขนาดไม่เกิน
                                        5MB)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Maintenance Mode Section -->
                        <div class="mt-4 p-3 rounded border"
                            [ngClass]="model.maintenance_mode == 1 ? 'bg-warning-subtle border-warning' : 'bg-light border-light'">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-1 fw-bold"
                                        [ngClass]="model.maintenance_mode == 1 ? 'text-warning-emphasis' : 'text-dark'">
                                        <i class="bi bi-tools me-2"></i>Maintenance Mode
                                    </h6>
                                    <small class="text-muted">เปิดโหมดนี้เพื่อระงับการแจ้งเตือนและบันทึก Log
                                        ชั่วคราว</small>
                                </div>
                                <div class="form-check form-switch form-switch-lg">
                                    <input class="form-check-input" type="checkbox" id="maSwitch"
                                        [ngModel]="model.maintenance_mode == 1"
                                        (ngModelChange)="model.maintenance_mode = $event ? 1 : 0"
                                        name="maintenance_mode" style="cursor: pointer; transform: scale(1.3);">
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary px-4">บันทึกข้อมูล</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Image Confirmation Modal -->
    <div class="modal fade" id="deleteImageModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>ยืนยันการลบรูปภาพ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="fs-1 text-danger mb-3"><i class="bi bi-trash3"></i></div>
                    <h5 class="mb-2">ลบรูปภาพอ้างอิง?</h5>
                    <p class="text-muted mb-0">
                        คุณต้องการลบรูปภาพอ้างอิงของ<br>
                        <strong>{{ model.durable_name }}</strong> ใช่หรือไม่?
                    </p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-danger px-4" (click)="confirmDeleteImage()">
                        <i class="bi bi-trash me-1"></i>ลบรูปภาพ
                    </button>
                </div>
            </div>
        </div>
    </div>
</app-auth-content>

<!-- Toast Notification -->
<app-toast [message]="toastMessage" [type]="toastType" (closed)="clearToast()"></app-toast>