<app-auth-content>
    <div class="app-title">
        <div>
            <h1><i class="bi bi-speedometer"></i> Devices</h1>
            <p>รายการข้อมูลครุภัณฑ์{{ Title }}</p>
        </div>
        <ul class="app-breadcrumb breadcrumb">
            <li class="breadcrumb-item"><a [routerLink]="['/', AppUrl.Authen, AuthUrl.Dashboard]"><i
                        class="bi bi-house-door fs-6"></i></a></li>
            <li class="breadcrumb-item"><a [routerLink]="[]">Devices</a></li>
        </ul>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="tile">
                <form (submit)="onSearchItem()">
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold me-2"><i class="bi bi-funnel"></i> กรองตามสถานะ:</label>
                        <div class="form-check form-check-inline" *ngFor="let status of statusItems">
                            <input class="form-check-input" type="checkbox" [id]="'status-' + status.status_id"
                                [checked]="selectedStatusIds.includes(status.status_id!)"
                                (change)="onStatusChange(status.status_id!, $any($event.target).checked)">
                            <label class="form-check-label" [for]="'status-' + status.status_id"
                                style="cursor: pointer;">
                                <span class="badge" [ngClass]="{
                                    'bg-success': status.status_id === '1',
                                    'bg-warning': status.status_id === '2',
                                    'bg-danger': status.status_id === '3',
                                    'bg-secondary': status.status_id === '4'
                                }">
                                    {{ status.status_name }}
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <input type="text" class="form-control" [(ngModel)]="searchText" (input)="onSearchItem()"
                                placeholder="ค้นหา... (เลขครุภัณฑ์, ชื่อ, ยี่ห้อ, IP, สถานที่)" name="searchText">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
                                <button class="btn btn-danger ml-1" type="button" (click)="onResetSearch()"><i
                                        class="bi bi-x-circle"></i> Reset</button>
                            </div>
                        </div>
                    </div>
                </form>
                <div *ngIf="isLoading" class="text-center mt-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="table-responsive" *ngIf="!isLoading">
                    <table class="table table-striped table-bordered table-hover">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 10%">เลขครุภัณฑ์</th>
                                <th class="text-center" style="width: 15%">รายการ</th>
                                <th class="text-center" style="width: 8%">ยี่ห้อ</th>
                                <th class="text-center" style="width: 8%">รุ่น</th>
                                <th class="text-center" style="width: 8%">ชั้น</th>
                                <th class="text-center" style="width: 12%">สถานที่</th>
                                <th class="text-center" style="width: 10%">รายละเอียด</th>
                                <th class="text-center" style="width: 10%">สถานะ</th>
                                <th class="text-center" style="width: 10%">IP</th>
                                <th class="text-center" style="width: 5%">Ping</th>
                                <th class="text-center" style="width: 4%">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of cctvItems">
                                <td>{{ item.durable_no }}</td>
                                <td>{{ item.durable_name }}</td>
                                <td>{{ item.brand }}</td>
                                <td>{{ item.model }}</td>
                                <td>{{ item.floor }}</td>
                                <td>{{ item.location }}</td>
                                <td>{{ item.monitor }}</td>
                                <td class="text-center">
                                    <ng-container *ngIf="item.maintenance_mode == 1; else normalStatus">
                                        <span class="badge bg-secondary"><i class="bi bi-tools"></i> Maintenance</span>
                                    </ng-container>
                                    <ng-template #normalStatus>
                                        <span class="badge" [ngClass]="{
                                                  'bg-success': item.status_id === '1',
                                                  'bg-warning': item.status_id === '2',
                                                  'bg-danger': item.status_id === '3',
                                                  'bg-secondary': item.status_id === '4'
                                              }">
                                            {{ item.status }}
                                        </span>
                                    </ng-template>
                                </td>

                                <td><a href="http://{{ item.ip }}" target="_blank">{{ item.ip }}</a></td>
                                <td class="text-center">
                                    <span class="badge" [ngClass]="item.ping === '0' ? 'bg-success' : 'bg-danger'">
                                        {{ item.ping === '0' ? 'Online' : 'Offline' }}
                                    </span>
                                </td>
                                <td align="center">
                                    <a [routerLink]="[]" data-bs-toggle="modal" data-bs-target="#editCctvModal"
                                        (click)="onEditModal(item)">
                                        <span class="badge bg-warning"><i class="bi bi-pencil-square"
                                                title="Edit"></i></span>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="11">จำนวนรายการทั้งหมด {{ cctvItems.length }} รายการ</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Modal HTML -->
    <div id="editCctvModal" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form (submit)="onSubmit()">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>แก้ไขรายการครุภัณฑ์</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Column 1: Basic Info -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3 border-bottom pb-2">ข้อมูลทั่วไป</h6>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">เลขครุภัณฑ์</label>
                                    <input type="text" class="form-control" required placeholder="ระบุเลขครุภัณฑ์"
                                        [(ngModel)]="model.durable_no" name="durable_no">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">รายการ</label>
                                    <input type="text" class="form-control" required placeholder="ระบุชื่อรายการ"
                                        [(ngModel)]="model.durable_name" name="durable_name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">ยี่ห้อ</label>
                                    <input type="text" class="form-control" required placeholder="ระบุยี่ห้อ"
                                        [(ngModel)]="model.brand" name="brand">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">รุ่น</label>
                                    <input type="text" class="form-control" required placeholder="ระบุรุ่น"
                                        [(ngModel)]="model.model" name="model">
                                </div>
                            </div>

                            <!-- Column 2: Location & Status -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3 border-bottom pb-2">สถานที่และสถานะ</h6>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">ชั้น</label>
                                    <select class="form-select" [(ngModel)]="model.floor_id" name="floor">
                                        <option value="">กรุณาเลือกชั้น</option>
                                        <option *ngFor="let item of floorItems" [value]="item.floor_id">{{
                                            item.floor_name }}
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">สถานที่</label>
                                    <input type="text" class="form-control" required placeholder="ระบุสถานที่ติดตั้ง"
                                        [(ngModel)]="model.location" name="location">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Monitor</label>
                                    <input type="text" class="form-control" required placeholder="ระบุ Monitor"
                                        [(ngModel)]="model.monitor" name="monitor">
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">สถานะ</label>
                                        <select class="form-select" [(ngModel)]="model.status_id" name="status">
                                            <option value="">เลือกสถานะ</option>
                                            <option *ngFor="let item of statusItems" [value]="item.status_id">{{
                                                item.status_name }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">IP Address</label>
                                        <input type="text" class="form-control font-monospace" required
                                            placeholder="xxx.xxx.xxx.xxx" [(ngModel)]="model.ip" name="ip">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Maintenance Mode Section -->
                        <div class="mt-4 p-3 rounded border"
                            [ngClass]="model.maintenance_mode == 1 ? 'bg-warning-subtle border-warning' : 'bg-light border-light'">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-1 fw-bold"
                                        [ngClass]="model.maintenance_mode == 1 ? 'text-warning-emphasis' : 'text-dark'">
                                        <i class="bi bi-tools me-2"></i>Maintenance Mode
                                    </h6>
                                    <small class="text-muted">เปิดโหมดนี้เพื่อระงับการแจ้งเตือนและบันทึก Log
                                        ชั่วคราว</small>
                                </div>
                                <div class="form-check form-switch form-switch-lg">
                                    <input class="form-check-input" type="checkbox" id="maSwitch"
                                        [ngModel]="model.maintenance_mode == 1"
                                        (ngModelChange)="model.maintenance_mode = $event ? 1 : 0"
                                        name="maintenance_mode" style="cursor: pointer; transform: scale(1.3);">
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary px-4">บันทึกข้อมูล</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</app-auth-content>