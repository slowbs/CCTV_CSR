<div class="monitor-display-mode">
    <div class="d-flex justify-content-end mb-3">
        <div class="form-check form-switch custom-switch">
            <input class="form-check-input" type="checkbox" id="rackToggle" [checked]="showDisconnected"
                (change)="toggleDisconnected()">
            <label class="form-check-label text-warning small" for="rackToggle">
                Show Disconnected
            </label>
        </div>
    </div>
    <div class="monitor-grid">
        <div class="rack-cabinet" *ngFor="let rack of floorRacks; trackBy: trackByRack" [ngClass]="{
                'rack-42u': rack.floor_name.includes('3') || rack.floor_name.includes('Server'),
                'rack-12u': rack.floor_name.includes('G') || rack.floor_name.includes('Ground'),
                'rack-8u': !rack.floor_name.includes('3') && !rack.floor_name.includes('Server') && !rack.floor_name.includes('G') && !rack.floor_name.includes('Ground'),
                'has-offline': rack.hasOffline,
                'has-maintenance': rack.hasMaintenance && !rack.hasOffline
            }">
            <div class="rack-header">
                <h3>{{ rack.floor_name }}</h3>
                <div class="header-status">
                    <span *ngIf="rack.hasOffline" class="badge badge-danger mr-1">Offline: {{ rack.offlineCount
                        }}</span>
                    <span *ngIf="rack.hasMaintenance" class="badge badge-warning mr-1">MA: {{ rack.maintenanceCount
                        }}</span>
                    <span class="badge bg-dark">{{ rack.slots.length }} Devices</span>
                </div>
            </div>
            <div class="rack-body">
                <div class="rack-rail">
                    <div class="rack-slot" *ngFor="let slot of rack.slots">
                        <div class="slot-content">
                            <div class="slot-info">
                                <span class="device-name text-truncate"
                                    tooltip="{{ slot.durable_no }} : {{ slot.monitor }}" container="body"
                                    placement="auto">
                                    {{ slot.durable_name }}
                                </span>
                            </div>
                            <div class="slot-status">
                                <div class="status-dot-group">
                                    <div *ngFor="let item of slot.items" class="status-dot" [ngClass]="{
                                            'online': item.ping === '0' && item.maintenance_mode != 1 && item.status_id == '1', 
                                            'offline': item.ping !== '0' && item.maintenance_mode != 1 && item.status_id == '1', 
                                            'maintenance': item.maintenance_mode == 1,
                                            'disconnected': item.status_id == '2'
                                        }" (click)="openDetailModal(item)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="detailModalLabel">Device Details</h5>
                <button type="button" class="close" (click)="closeDetailModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" *ngIf="selectedItem">
                <div class="row mb-2">
                    <div class="col-4 text-secondary">Name:</div>
                    <div class="col-8 font-weight-bold">{{ selectedItem.durable_name }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-4 text-secondary">Durable No:</div>
                    <div class="col-8">{{ selectedItem.durable_no }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-4 text-secondary">IP Address:</div>
                    <div class="col-8">{{ selectedItem.ip }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-4 text-secondary">Location:</div>
                    <div class="col-8">{{ selectedItem.location }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-4 text-secondary">Floor:</div>
                    <div class="col-8">{{ selectedItem.floor }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-4 text-secondary">Monitor</div>
                    <div class="col-8">{{ selectedItem.monitor }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-4 text-secondary">Status:</div>
                    <div class="col-8">
                        <span [ngClass]="{
                                'text-success': selectedItem.ping === '0' && selectedItem.status_id == '1', 
                                'text-danger': selectedItem.ping !== '0' && selectedItem.status_id == '1',
                                'text-muted': selectedItem.status_id == '2'
                            }">
                            {{ getDeviceStatus(selectedItem) }}
                        </span>
                    </div>
                </div>

                <!-- Reference Image Section -->
                <div class="mt-3 text-center" *ngIf="selectedItem.image_path">
                    <div class="text-secondary mb-2 small">Reference Image <small class="text-muted ms-1">(Click to
                            expand)</small></div>
                    <img [src]="getDeviceImageUrl(selectedItem.image_path)" class="img-fluid rounded"
                        style="max-height: 180px; border: 1px solid #3a3a3a; cursor: pointer; transition: transform 0.2s;"
                        (click)="openImagePreview(selectedItem.image_path)"
                        onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'"
                        alt="Device Image">
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal (Stacked) -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" style="background: rgba(0,0,0,0.8);">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 90vw;">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-header border-0 p-0 mb-2">
                <div class="w-100 d-flex justify-content-end">
                    <button type="button" class="btn btn-dark rounded-circle" (click)="closeImagePreview()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body p-0 text-center">
                <img [src]="previewImageUrl" *ngIf="previewImageUrl" class="img-fluid rounded shadow-lg"
                    style="max-height: 90vh; border: 2px solid #555;">
            </div>
        </div>
    </div>
</div>