<app-auth-content>
    <div class="app-title">
        <div>
            <h1><i class="bi bi-clock-history"></i> Device History</h1>
            <p>ประวัติการเปลี่ยนแปลงข้อมูลอุปกรณ์</p>
        </div>
        <ul class="app-breadcrumb breadcrumb">
            <li class="breadcrumb-item"><a [routerLink]="['/', AppUrl.Authen, AuthUrl.Dashboard]"><i
                        class="bi bi-house-door fs-6"></i></a></li>
            <li class="breadcrumb-item active">Device History</li>
        </ul>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="tile">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h3 class="tile-title">
                            History Log
                            <span *ngIf="cctvId" class="text-muted h5 ml-2">(ID: {{ cctvId }})</span>
                        </h3>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" [(ngModel)]="searchText" (input)="onSearch()"
                                placeholder="ค้นหา (ชื่อ, เลขครุภัณฑ์, IP, สถานที่)">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div *ngIf="isLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>

                <div *ngIf="!isLoading && filteredLogs.length === 0" class="text-center py-5 text-muted">
                    No history found.
                </div>

                <div *ngIf="!isLoading && filteredLogs.length > 0" class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th style="width: 3%" class="text-center">ID</th>
                                <th *ngIf="!cctvId" style="width: 15%">Device</th>
                                <th class="text-center">Floor</th>
                                <th class="text-center">Location</th>
                                <th class="text-center">Monitor</th>
                                <th class="text-center">Status</th>
                                <th class="text-center" style="width: 19%">IP Address</th>
                                <th style="width: 10%" class="text-center">Date/Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let log of filteredLogs" class="change-row">
                                <td class="text-center text-muted">{{ log.id }}</td>
                                <td *ngIf="!cctvId" class="device-info">
                                    <div class="device-name fw-bold">{{ log.durable_name }}</div>
                                    <div class="device-no">{{ log.durable_no }}</div>
                                </td>
                                <td class="text-center">
                                    <ng-container *ngIf="log.old_floor !== log.new_floor">
                                        <span class="diff-removed">{{ log.old_floor }}</span>
                                        <i class="bi bi-arrow-right diff-arrow"></i>
                                        <span class="diff-added">{{ log.new_floor }}</span>
                                    </ng-container>
                                    <span *ngIf="log.old_floor === log.new_floor" class="value-unchanged">{{
                                        log.new_floor }}</span>
                                </td>
                                <td>
                                    <ng-container *ngIf="log.old_location !== log.new_location">
                                        <span class="diff-removed">{{ log.old_location }}</span>
                                        <i class="bi bi-arrow-right diff-arrow"></i>
                                        <span class="diff-added">{{ log.new_location }}</span>
                                    </ng-container>
                                    <span *ngIf="log.old_location === log.new_location" class="value-unchanged">{{
                                        log.new_location }}</span>
                                </td>
                                <td>
                                    <ng-container *ngIf="log.old_monitor !== log.new_monitor">
                                        <span class="diff-removed">{{ log.old_monitor }}</span>
                                        <i class="bi bi-arrow-right diff-arrow"></i>
                                        <span class="diff-added">{{ log.new_monitor }}</span>
                                    </ng-container>
                                    <span *ngIf="log.old_monitor === log.new_monitor" class="value-unchanged">{{
                                        log.new_monitor }}</span>
                                </td>
                                <td>
                                    <ng-container *ngIf="log.old_status !== log.new_status">
                                        <span class="diff-removed">{{ log.old_status }}</span>
                                        <i class="bi bi-arrow-right diff-arrow"></i>
                                        <span class="diff-added">{{ log.new_status }}</span>
                                    </ng-container>
                                    <span *ngIf="log.old_status === log.new_status" class="value-unchanged">{{
                                        log.new_status }}</span>
                                </td>
                                <td>
                                    <ng-container *ngIf="log.old_ip !== log.new_ip">
                                        <span class="diff-removed font-monospace">{{ log.old_ip }}</span>
                                        <i class="bi bi-arrow-right diff-arrow"></i>
                                        <span class="diff-added font-monospace">{{ log.new_ip }}</span>
                                    </ng-container>
                                    <span *ngIf="log.old_ip === log.new_ip" class="value-unchanged font-monospace">{{
                                        log.new_ip }}</span>
                                </td>
                                <td class="text-center timestamp">{{ formatDateBE(log.updated_at) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div *ngIf="!isLoading && totalItems > 0" class="row mt-3">
                    <div class="col-md-6 text-muted">
                        Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ currentPage * pageSize > totalItems ?
                        totalItems : currentPage * pageSize }} of {{ totalItems }} entries
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-end mb-0">
                                <li class="page-item" [class.disabled]="currentPage === 1">
                                    <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage - 1)"
                                        aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item" *ngFor="let page of pages" [class.active]="page === currentPage"
                                    [class.disabled]="page === -1">
                                    <a class="page-link" href="javascript:void(0)"
                                        (click)="page !== -1 && changePage(page)">
                                        {{ page === -1 ? '...' : page }}
                                    </a>
                                </li>
                                <li class="page-item" [class.disabled]="currentPage === totalPages">
                                    <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage + 1)"
                                        aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</app-auth-content>

<!-- Toast Notification -->
<app-toast [message]="toastMessage" [type]="toastType" (closed)="clearToast()"></app-toast>