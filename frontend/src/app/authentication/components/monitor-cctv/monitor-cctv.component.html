<div class="monitor-map-container">

    <!-- LEFT: Map List -->
    <div class="sidebar-maps">
        <div class="sidebar-header">
            <h5 class="mb-0"><i class="bi bi-map me-2"></i>Maps</h5>
            <span class="badge bg-accent">{{ maps.length }}</span>
        </div>
        <div class="map-list" *ngIf="maps.length > 0; else noMaps">
            <div class="map-item" *ngFor="let map of maps" [class.active]="selectedMap?.id === map.id"
                (click)="selectMap(map)">
                <i class="bi bi-pin-map-fill map-icon me-2"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold text-truncate" style="max-width: 150px;">{{ map.name }}</div>
                    <small class="text-muted">{{ map.cctv_count || 0 }} cameras</small>
                </div>
                <div class="map-status-indicators">
                    <div class="status-dot status-offline" *ngIf="hasMapOffline(map.id)"></div>
                    <div class="status-dot status-ma" *ngIf="hasMapMa(map.id)"></div>
                    <div class="status-dot status-disconnected" *ngIf="hasMapDisconnected(map.id)"></div>
                    <div class="status-dot status-online"
                        *ngIf="!hasMapOffline(map.id) && !hasMapMa(map.id) && !hasMapDisconnected(map.id)"></div>
                </div>
            </div>
        </div>
        <ng-template #noMaps>
            <div class="empty-state">
                <i class="bi bi-map fs-1 mb-2"></i>
                <p>No maps available.<br>Contact admin.</p>
            </div>
        </ng-template>
    </div>

    <!-- CENTER: Map View -->
    <div class="main-canvas">
        <div class="canvas-toolbar">
            <div class="status-summary-bar">
                <div class="summary-stat total">
                    <i class="bi bi-camera-video-fill"></i>
                    <span class="stat-value">{{ getTotalCount() }}</span>
                    <span class="stat-label">Total</span>
                </div>
                <div class="summary-stat online">
                    <i class="bi bi-check-circle-fill"></i>
                    <span class="stat-value">{{ getTotalOnlineCount() }}</span>
                    <span class="stat-label">Online</span>
                </div>
                <div class="summary-stat offline">
                    <i class="bi bi-x-circle-fill"></i>
                    <span class="stat-value">{{ getTotalOfflineCount() }}</span>
                    <span class="stat-label">Offline</span>
                </div>
                <div class="summary-stat ma">
                    <i class="bi bi-cone-striped"></i>
                    <span class="stat-value">{{ getTotalMaCount() }}</span>
                    <span class="stat-label">MA</span>
                </div>
                <div class="summary-stat disconnected">
                    <i class="bi bi-eye-slash-fill"></i>
                    <span class="stat-value">{{ getTotalDisconnectedCount() }}</span>
                    <span class="stat-label">Disconnected</span>
                </div>
            </div>
        </div>

        <div class="canvas-viewport">
            <div class="map-container" *ngIf="selectedMap; else selectMapPrompt" #mapContainer>
                <img [src]="selectedMap.image_url" class="map-image" alt="Floor Plan">

                <!-- Markers with status -->
                <div *ngFor="let cam of getMapCameras()" class="cctv-marker" [style.left.%]="cam.map_x"
                    [style.top.%]="cam.map_y" [ngClass]="{
                        'marker-online': cam.ping === '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                        'marker-offline': cam.ping !== '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                        'marker-ma': cam.maintenance_mode == 1 && cam.status_id == '1',
                        'marker-disconnected': cam.status_id == '2'
                    }" (click)="openDetailModal(cam)">
                    <i class="bi bi-camera-video-fill"></i>
                    <div class="marker-tooltip" [ngClass]="{
                        'tooltip-bottom': (cam.map_y || 0) < 15,
                        'tooltip-align-right': (cam.map_x || 0) < 15,
                        'tooltip-align-left': (cam.map_x || 0) > 85
                    }">
                        <div class="fw-bold">{{ cam.location || cam.durable_name }}</div>
                        <div class="small">{{ cam.floor }} - {{ cam.monitor }}</div>
                        <div class="small text-accent">{{ cam.ip }}</div>
                        <div class="status-badge mt-1" [ngClass]="{
                            'badge-online': cam.ping === '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                            'badge-offline': cam.ping !== '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                            'badge-ma': cam.maintenance_mode == 1 && cam.status_id == '1',
                            'badge-disconnected': cam.status_id == '2'
                        }">
                            {{ cam.status_id == '2' ? 'Disconnected' : (cam.maintenance_mode == 1 ? 'MA Mode' :
                            (cam.ping === '0' ? 'Online' : 'Offline')) }}
                        </div>
                    </div>
                </div>
            </div>

            <ng-template #selectMapPrompt>
                <div class="empty-state-center">
                    <i class="bi bi-pin-map fs-1 mb-3"></i>
                    <h4>Select a Map</h4>
                    <p class="text-muted">Choose a map from the left panel to view cameras.</p>
                </div>
            </ng-template>
        </div>
    </div>

    <!-- RIGHT: Camera List -->
    <div class="sidebar-cameras">
        <div class="sidebar-header">
            <h5 class="mb-0"><i class="bi bi-camera-video me-2"></i>{{ selectedMap ? selectedMap.name : 'Cameras' }}
            </h5>
            <span class="badge bg-accent" *ngIf="selectedMap">{{ getMapCameras().length }}</span>
        </div>

        <!-- Status Summary -->
        <div class="status-summary" *ngIf="selectedMap">
            <div class="summary-item online">
                <i class="bi bi-check-circle-fill"></i>
                <span>{{ getOnlineCount() }}</span>
            </div>
            <div class="summary-item offline">
                <i class="bi bi-x-circle-fill"></i>
                <span>{{ getOfflineCount() }}</span>
            </div>
            <div class="summary-item ma">
                <i class="bi bi-cone-striped"></i>
                <span>{{ getMaCount() }}</span>
            </div>
            <div class="summary-item disconnected">
                <i class="bi bi-eye-slash-fill"></i>
                <span>{{ getDisconnectedCount() }}</span>
            </div>
        </div>

        <!-- Search & Toggle -->
        <div class="filter-bar" *ngIf="selectedMap">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="form-check form-switch custom-switch">
                    <input class="form-check-input" type="checkbox" id="showDisconnectedToggle"
                        [checked]="showDisconnected" (change)="toggleDisconnected()">
                    <label class="form-check-label text-warning small" for="showDisconnectedToggle"
                        style="font-size: 0.8rem;">
                        Show Disconnected
                    </label>
                </div>
            </div>
            <input type="text" class="form-control form-control-sm" placeholder="Search camera..."
                [(ngModel)]="searchText" (keyup)="filterCameras()">
        </div>

        <!-- Camera List -->
        <div class="camera-scroller" *ngIf="selectedMap; else selectMapFirst">
            <div *ngFor="let cam of filteredCameras" class="camera-card" (click)="openDetailModal(cam)" [ngClass]="{
                    'card-online': cam.ping === '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                    'card-offline': cam.ping !== '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                    'card-ma': cam.maintenance_mode == 1 && cam.status_id == '1',
                    'card-disconnected': cam.status_id == '2'
                }">
                <div class="camera-status-dot" [ngClass]="{
                    'dot-online': cam.ping === '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                    'dot-offline': cam.ping !== '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                    'dot-ma': cam.maintenance_mode == 1 && cam.status_id == '1',
                    'dot-disconnected': cam.status_id == '2'
                }"></div>
                <div class="camera-info">
                    <div class="fw-bold text-truncate" [title]="cam.durable_name">{{ cam.location || cam.durable_name }}
                    </div>
                    <div class="small text-muted">{{ cam.floor }} - {{ cam.monitor }}</div>
                    <div class="small text-accent">{{ cam.ip }}</div>
                </div>
                <div class="camera-status-badge" [ngClass]="{
                    'status-online': cam.ping === '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                    'status-offline': cam.ping !== '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                    'status-ma': cam.maintenance_mode == 1 && cam.status_id == '1',
                    'status-disconnected': cam.status_id == '2'
                }">
                    <i class="bi" [ngClass]="{
                        'bi-check-lg': cam.ping === '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                        'bi-x-lg': cam.ping !== '0' && cam.maintenance_mode != 1 && cam.status_id == '1',
                        'bi-cone-striped': cam.maintenance_mode == 1 && cam.status_id == '1',
                        'bi-eye-slash-fill': cam.status_id == '2'
                    }"></i>
                </div>
            </div>

            <div *ngIf="filteredCameras.length === 0 && searchText" class="empty-state mt-4">
                <i class="bi bi-search fs-3 mb-2"></i>
                <p class="small">No cameras found.</p>
            </div>
        </div>

        <ng-template #selectMapFirst>
            <div class="empty-state">
                <i class="bi bi-arrow-left-circle fs-1 mb-2"></i>
                <p>Select a map first<br>to see cameras.</p>
            </div>
        </ng-template>
    </div>

</div>

<!-- Detail Modal -->
<div class="modal fade" id="cctvDetailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content dark-theme">
            <div class="modal-header dark-theme">
                <h5 class="modal-title" id="detailModalLabel">
                    <i class="bi bi-info-circle me-2"></i>Device Details
                </h5>
                <button type="button" class="btn-close btn-close-white" aria-label="Close"
                    (click)="closeDetailModal()"></button>
            </div>
            <div class="modal-body" *ngIf="selectedItem">
                <div class="text-center mb-4">
                    <!-- Show image if exists, otherwise show icon -->
                    <!-- Show image if exists, otherwise show icon -->
                    <ng-container *ngIf="selectedItem.image_path; else cameraIcon">
                        <img [src]="getDeviceImageUrl(selectedItem.image_path)" class="img-fluid rounded mb-2"
                            style="max-height: 180px; border: 2px solid #3a3a3a; cursor: pointer; transition: transform 0.2s;"
                            (click)="openImagePreview(selectedItem.image_path)"
                            onmouseover="this.style.transform='scale(1.02)'"
                            onmouseout="this.style.transform='scale(1)'" alt="Camera View">
                        <div class="small text-muted mb-2">(Click to expand)</div>
                    </ng-container>
                    <ng-template #cameraIcon>
                        <i class="bi bi-camera-video-fill display-1" [ngClass]="{
                                'status-online': selectedItem.ping === '0' && selectedItem.maintenance_mode != 1,
                                'status-offline': selectedItem.ping !== '0' && selectedItem.maintenance_mode != 1,
                                'status-ma': selectedItem.maintenance_mode == 1
                           }">
                        </i>
                    </ng-template>
                    <h4 class="mt-2 text-white">{{ selectedItem.durable_name }}</h4>
                    <span class="badge" [ngClass]="{
                            'bg-success': selectedItem.ping === '0' && selectedItem.maintenance_mode != 1,
                            'bg-danger': selectedItem.ping !== '0' && selectedItem.maintenance_mode != 1,
                            'bg-warning text-dark': selectedItem.maintenance_mode == 1
                        }">
                        {{ selectedItem.maintenance_mode == 1 ? 'Maintenance Mode' : (selectedItem.ping === '0' ?
                        'Online' : 'Offline') }}
                    </span>
                </div>

                <div class="detail-row row">
                    <div class="col-4 detail-label">IP Address</div>
                    <div class="col-8 detail-value">{{ selectedItem.ip }}</div>
                </div>
                <div class="detail-row row">
                    <div class="col-4 detail-label">Durable No</div>
                    <div class="col-8 detail-value">{{ selectedItem.durable_no }}</div>
                </div>
                <div class="detail-row row">
                    <div class="col-4 detail-label">Location</div>
                    <div class="col-8 detail-value">{{ selectedItem.location || '-' }}</div>
                </div>
                <div class="detail-row row">
                    <div class="col-4 detail-label">Floor</div>
                    <div class="col-8 detail-value">{{ selectedItem.floor || '-' }}</div>
                </div>

                <div class="detail-row row">
                    <div class="col-4 detail-label">Monitor</div>
                    <div class="col-8 detail-value">{{ selectedItem.monitor || '-' }}</div>
                </div>
                <div class="detail-row row">
                    <div class="col-4 detail-label">Last Checked</div>
                    <div class="col-8 detail-value">{{ selectedItem.date_updated | date:'medium' }}</div>
                </div>

            </div>
            <div class="modal-footer dark-theme">
                <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal (Stacked) -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" style="background: rgba(0,0,0,0.8);">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 90vw;">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-header border-0 p-0 mb-2">
                <div class="w-100 d-flex justify-content-end">
                    <button type="button" class="btn btn-dark rounded-circle" (click)="closeImagePreview()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body p-0 text-center">
                <img [src]="previewImageUrl" *ngIf="previewImageUrl" class="img-fluid rounded shadow-lg"
                    style="max-height: 90vh; border: 2px solid #555;">
            </div>
        </div>
    </div>
</div>